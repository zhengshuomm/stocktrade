# 股票交易模拟系统 (trade_stock.py)

## 概述
基于异常检测数据的自动化股票交易模拟系统，根据期权异常信号进行买入/卖出决策。

## 功能特性
- **数据库管理**: 自动创建和管理用户账户、交易历史表
- **信号分析**: 读取持仓量和成交量异常检测结果
- **智能交易**: 基于看涨/看跌信号进行买入/卖出决策
- **风险控制**: 设置持有时间限制和买入金额比例
- **实时更新**: 持续更新股票价格和账户价值

## 数据库设计

### User 表
- `cash`: 现金余额 (初始: 100,000)
- `stock`: 持有股票总价值
- `total_value`: 总资产 (自动计算: cash + stock)

### Transaction_History 表
- `transaction_id`: 交易ID (主键)
- `symbol`: 股票代码
- `buy_price`: 买入价格
- `sell_price`: 卖出价格
- `current_price`: 当前价格
- `number_shares`: 持有股数
- `amount`: 当前价值 (自动计算)
- `gain`: 盈亏 (自动计算)
- `is_hold`: 是否持有
- `buy_date`: 买入时间
- `sell_date`: 卖出时间

## 交易逻辑

### 买入条件
1. **数据源**: 读取最新的异常检测文件
2. **时效性**: 文件时间戳与当前时间差 ≤ 5分钟
3. **信号要求**: 
   - 看涨信号 ≥ 2个
   - 看跌信号 = 0个
4. **资金要求**: 现金 ≥ 总资产的10%

### 卖出条件
1. **看跌信号 ≥ 3个**: 立即卖出
2. **只有看跌信号**: 立即卖出
3. **持有时间 > 24小时**: 且无新信号时卖出
4. **只有看涨信号**: 继续持有

### 交易规则
- **买入金额**: 总资产的10%
- **全量交易**: 每次卖出全部股数
- **唯一持有**: 每个股票只能持有一只
- **实时更新**: 持续更新价格和盈亏

## 使用方法

### 基本运行
```bash
python3 program/trade_stock.py
```

### 测试程序
```bash
python3 test_trade_stock.py
```

### 日志文件
程序运行日志保存在 `trade_stock.log` 文件中。

## 配置参数

```python
INITIAL_CASH = 100000.0        # 初始现金
BUY_RATIO = 0.1                # 买入比例 (10%)
HOLD_HOURS_LIMIT = 24          # 持有时间限制 (小时)
FILE_TIMEOUT_MINUTES = 5       # 文件超时时间 (分钟)
```

## 数据文件要求

### 异常检测文件
- **持仓量异常**: `data/outlier/*.csv`
- **成交量异常**: `data/volume_outlier/*.csv`

### 文件格式
文件必须包含以下列：
- `symbol`: 股票代码
- `signal_type`: 信号类型 (包含"看涨"或"看跌")

## 错误处理
- 数据库连接失败
- 文件读取错误
- 股票价格获取失败
- 交易执行失败

## 注意事项
1. 确保数据库连接正常
2. 确保异常检测文件存在且格式正确
3. 程序会创建数据库表，请确保有相应权限
4. 建议在测试环境中先验证功能

## 扩展功能
- 支持多种交易策略
- 添加更多风险控制参数
- 集成更多数据源
- 添加性能分析功能
